---
title: "GitHub Actionsã§æœ¬ç•ªç’°å¢ƒã¨æ¤œè¨¼ç’°å¢ƒã«ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’pushã™ã‚‹æ–¹æ³•"
emoji: "ğŸ³"
type: "tech"
topics:
  - "github"
  - "github-actions"
  - "aws"
  - "ecs"
  - "fargate"
published: true
published_at: "2024-12-11 00:00"
---

## ğŸ¯ ã“ã®è¨˜äº‹ã®ç›®çš„
GitHub Actions ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ AWS Elastic Container Registry (ECR) ã« push ã™ã‚‹éš›ã€**æœ¬ç•ªç’°å¢ƒã¨æ¤œè¨¼ç’°å¢ƒã§ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ©ç”¨ã—ãŸã„ï¼** ã¨æ€ã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

ç‰¹ã« **ECS Fargate ã§é‹ç”¨ã—ã¦ã„ã‚‹å ´åˆ**ã€ç’°å¢ƒã”ã¨ã«é©åˆ‡ãªã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€**GitHub Actions ã§ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ push ã™ã‚‹æ–¹æ³•** ã‚’è§£èª¬ã—ã¾ã™ã€‚

## ğŸš€ ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ push ã™ã‚‹æ–¹æ³•
æœ¬ç•ªç’°å¢ƒã¨æ¤œè¨¼ç’°å¢ƒã§ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯ã€**ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã«ã‚¿ã‚°ã‚’åˆ†ã‘ã‚‹** ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚

### âœ… ã‚¿ã‚°ã®ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã‚‹
| ãƒ–ãƒ©ãƒ³ãƒå       | ç’°å¢ƒ     | ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° |
|---------------|--------|------------|
| `main`       | æœ¬ç•ªç’°å¢ƒ | `my-image:prod` |
| `develop`    | æ¤œè¨¼ç’°å¢ƒ | `my-image:staging` |
| `feature/*`  | é–‹ç™ºç’°å¢ƒ | `my-image:dev` |

GitHub Actions ã§ã¯ `GITHUB_REF` ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã„ã€**ã©ã®ãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹** ã‚’å–å¾—ã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹æ³•ã§ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ã§ãã¾ã™ã€‚

```yaml
- name: ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
  run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
```

ã“ã® `BRANCH_NAME` ã‚’ä½¿ã£ã¦ã€ECR ã« push ã™ã‚‹ã‚¿ã‚°ã‚’å‹•çš„ã«æ±ºã‚ã¾ã™ã€‚

## ğŸ“œ GitHub Actions ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
ä»¥ä¸‹ã¯ **GitHub Actions ã‚’ä½¿ã£ã¦ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ push ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¾‹** ã§ã™ã€‚

```yaml
name: Build and Push Docker Image

on:
  push:
    branches:
      - main
      - develop
      - "feature/*"

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: my-container-repo

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: AWS CLI ã‚’è¨­å®š
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ECR ã«ãƒ­ã‚°ã‚¤ãƒ³
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin <AWS_ACCOUNT_ID>.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚’æ±ºå®š
        run: |
          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "IMAGE_TAG=prod" >> $GITHUB_ENV
          elif [[ "$BRANCH_NAME" == "develop" ]]; then
            echo "IMAGE_TAG=staging" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
          fi

      - name: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

      - name: ECR ã« push
        run: |
          docker tag $ECR_REPOSITORY:$IMAGE_TAG <AWS_ACCOUNT_ID>.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
          docker push <AWS_ACCOUNT_ID>.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
```

## ğŸ› ï¸ Fargate ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒã‚¤ãƒ³ãƒˆ

### 1ï¸âƒ£ **ECS ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ç’°å¢ƒã”ã¨ã«æ›´æ–°ã™ã‚‹**
ECS Fargate ã§ã¯ `task-definition.json` ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠè¨­å®šã‚’æ›´æ–°ã§ãã¾ã™ã€‚

ç’°å¢ƒã”ã¨ã«é©åˆ‡ãªã‚¿ã‚°ã‚’é©ç”¨ã™ã‚‹ã«ã¯ã€GitHub Actions ã§ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’æ›´æ–°ã—ã¾ã—ã‚‡ã†ã€‚

```yaml
- name: ã‚¿ã‚¹ã‚¯å®šç¾©ã®æ›´æ–°
  run: |
    aws ecs update-service --cluster my-cluster \
      --service my-service \
      --force-new-deployment
```

ğŸ’¡ **`force-new-deployment` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã‚’ç¢ºå®Ÿã«é©ç”¨ï¼**

## ğŸ› ï¸ `task-definition.json` ã«å¤‰æ•°ã‚’åŸ‹ã‚è¾¼ã‚€æ–¹æ³•
**1. `task-definition.json` ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–**
ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã†ãŸã‚ã€`{{IMAGE_TAG}}` ã®ã‚ˆã†ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å…¥ã‚Œã¾ã™ã€‚

```json
{
  "family": "my-task",
  "containerDefinitions": [
    {
      "name": "my-app",
      "image": "123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/my-container-repo:{{IMAGE_TAG}}",
      "memory": 512,
      "cpu": 256,
      "essential": true
    }
  ]
}
```

**2. GitHub Actions ã§ `IMAGE_TAG` ã‚’åŸ‹ã‚è¾¼ã‚€**
YAML ã® `sed` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ã€**ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆ** ã¾ã™ã€‚

```yaml
- name: `task-definition.json` ã«ç’°å¢ƒå¤‰æ•°ã‚’åŸ‹ã‚è¾¼ã‚€
  run: |
    sed -i 's/{{IMAGE_TAG}}/'"$IMAGE_TAG"'/g' task-definition.json
```

ğŸ’¡ **ã“ã‚Œã§ `task-definition.json` å†…ã® `{{IMAGE_TAG}}` ãŒ `prod`, `staging`, `dev` ã«è‡ªå‹•ã§å¤‰ã‚ã‚‹ï¼**

## ğŸ¯ ã¾ã¨ã‚
GitHub Actions ã§æœ¬ç•ªç’°å¢ƒãƒ»æ¤œè¨¼ç’°å¢ƒã”ã¨ã« **ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ push ã™ã‚‹æ–¹æ³•** ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚

âœ… **ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã«ã‚¿ã‚°ã‚’åˆ†ã‘ã‚‹** (`prod`, `staging`, `dev`)
âœ… **GitHub Actions ã§ãƒ–ãƒ©ãƒ³ãƒã‚’åˆ¤å®šã—ã¦è‡ªå‹• push**
âœ… **`task-definition.json` ã«ç’°å¢ƒå¤‰æ•°ã‚’åŸ‹ã‚è¾¼ã‚€**
âœ… **Fargate ã® `force-new-deployment` ã‚’æ´»ç”¨ã—ã¦ç¢ºå®Ÿã«åæ˜ **

ã“ã‚Œã‚’ä½¿ãˆã°ã€ç’°å¢ƒã”ã¨ã«é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ãŒã§ãã€ãƒ‡ãƒ—ãƒ­ã‚¤ã®æŸ”è»Ÿæ€§ãŒå‘ä¸Šã—ã¾ã™ï¼
**ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼ğŸš€**
